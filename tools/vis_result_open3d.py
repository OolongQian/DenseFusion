import os
import open3d as o3d
import copy
import scipy.io as scio

id2name = {1: '002_master_chef_can',
           2: '003_cracker_box',
           3: '004_sugar_box',
           4: '005_tomato_soup_can',
           5: '006_mustard_bottle',
           6: '007_tuna_fish_can',
           7: '008_pudding_box',
           8: '009_gelatin_box',
           9: '010_potted_meat_can',
           10: '011_banana',
           11: '019_pitcher_base',
           12: '021_bleach_cleanser',
           13: '024_bowl',
           14: '025_mug',
           15: '035_power_drill',
           16: '036_wood_block',
           17: '037_scissors',
           18: '040_large_marker',
           19: '051_large_clamp',
           20: '052_extra_large_clamp',
           21: '061_foam_brick'}

if __name__ == "__main__":
    poses_path = "experiments/eval_result/ycb/Densefusion_wo_refine_result"
    masked_pld_path = "experiments/eval_result/ycb/masked_plds"
    model_path = "../../src/ur_perception/models"

    filenames = os.listdir(masked_pld_path)
    for filename in filenames:
        dataname = "_".join(filename.split("_")[:3])
        index = int(filename.split("_")[4])
        clsid = int(filename.split("_")[-1][:-4])
        clsname = id2name[clsid]

        "read partial pld generated by depth image."
        pld = o3d.io.read_point_cloud(os.path.join(masked_pld_path, filename))
        "read canonical model point cloud."
        model_pld = o3d.io.read_point_cloud(os.path.join(model_path, clsname, "points.xyz"))
        "translate it."
        # model_pld_trans = copy.deepcopy(model_pld).translate((1, 1, 1))
        "load predicted 6D pose."
        pose = scio.loadmat(os.path.join(poses_path, dataname))['poses'][index]
        pred_model_pld = copy.deepcopy(model_pld).translate(pose[4:])
        pred_model_pld.rotate(pred_model_pld.get_rotation_matrix_from_quaternion(pose[:4]),
                              center=pred_model_pld.get_center())
        "visualize it."
        o3d.visualization.draw_geometries([pld, pred_model_pld])

        break
